const { findById, saveCourseOutlineToDB, findRecentCoursesByUser, updateLastAccessed,
  markLessonCompleted,
  findLessonForUser,
  checkLessonExistsForUser,
  saveLesson,
} = require("../repository/course.repository");

const { getYouTubeVideos } = require("../repository/YouTube.repository");


const saveCourseOutlineToDBService = async (outline, userId) => {

  if (!outline?.course || !outline?.modules) {
    throw new Error("Invalid course outline structure");
  }

  const { course, modules } = outline;

  const courseDocument = {
    title: course.title || "Untitled Course",
    description: course.description || "Course generated by AI",
    courseObjective: course.courseObjective || "Master the topic",
    targetAudience: course.targetAudience || "Students and Professionals",
    durationDays: course.durationDays || 30,
    estimatedTotalTime: course.estimatedTotalTime || "40 hours",
    skillsGained: course.skillsGained || [],
    assessmentPlan: course.assessmentPlan || "Quizzes and Exercises",
    userId,
    modules: modules.map((m, idx) => ({
      moduleIndex: m.moduleIndex || idx + 1,
      recommendedOrder: m.recommendedOrder || m.moduleIndex || idx + 1,
      title: m.title || `Module ${idx + 1}`,
      description: m.description || `Learning module for ${m.title || "the course"}`,
      moduleObjective: m.moduleObjective || "Complete module topics",
      difficultyLevel: m.difficultyLevel || "Intermediate",
      estimatedTime: m.estimatedTime || "8 hours",
      prerequisites: m.prerequisites || [],
      coveredConcepts: m.coveredConcepts || [],
      excludedConcepts: m.excludedConcepts || [],
      learningOutcomes: m.learningOutcomes || [],
      topics: m.topics || [],
      lessons: (m.lessons || []).map((l, lIdx) => ({
        lessonIndex: l.lessonIndex || lIdx + 1,
        title: l.title || `Lesson ${lIdx + 1}`,
        lessonObjective: l.lessonObjective || "",
        briefDescription: l.description || l.briefDescription || "Lesson content",
      })),
    })),
  };

  return await saveCourseOutlineToDB(courseDocument);
};


const getRecentCoursesService = async (userId) => {
  if (!userId) {
    throw new Error("User ID is required");
  }

  const courses = await findRecentCoursesByUser(userId);

  return courses.map(course => ({
    courseId: course._id,
    courseTitle: course.title,
    courseDescription: course.description,
  }));
};



const getCourseDetailsWithProgressService = async (courseId, userId) => {
  if (!courseId || !userId) {
    throw new Error("Course ID and User ID are required");
  }

  const course = await findById(courseId);
  if (!course) {
    throw new Error("Course not found");
  }

  updateLastAccessed(course._id);


  let currentModuleIndex = 0;
  let currentLessonIndex = 0;

  for (let i = 0; i < course.modules.length; i++) {
    if (course.modules[i].isCompleted === false) {
      currentModuleIndex = i + 1;
      break;
    }
  }

  if (currentModuleIndex === 0) {
    return {
      course,
      progress: {
        currentModule: course.modules.length,
        currentLesson: course.modules[course.modules.length - 1].lessons.length,
      },
    };
  }

  for (let i = 0; i < course.modules[currentModuleIndex - 1].lessons.length; i++) {
    if (course.modules[currentModuleIndex - 1].lessons[i].isCompleted === false) {
      currentLessonIndex = i + 1;
      break;
    }
  }

  return {
    course,
    progress: {
      currentModule: currentModuleIndex,
      currentLesson: currentLessonIndex,
    },
  };
};


const completeLessonService = async ({
  courseId,
  userId,
  moduleIndex,
  lessonIndex,
}) => {
  if (!courseId || !userId || moduleIndex === null || lessonIndex === null) {
    throw new Error("Missing required parameters");
  }

  const course =
    await markLessonCompleted({
      courseId,
      userId,
      moduleIndex,
      lessonIndex,
    });

  if (!course) {
    throw new Error("Course not found");
  }

  return {
    message: "Lesson marked as completed",
  };
};


const getLessonContentService = async ({
  courseId,
  userId,
  moduleIndex,
  lessonIndex,
}) => {
  const result =
    await findLessonForUser({
      courseId,
      userId,
      moduleIndex,
      lessonIndex,
    });

  if (!result) {
    throw new Error("Lesson not found");
  }

  const { module, lesson } = result;

  return {
    lesson: {
      title: lesson.title,
      description: lesson.briefDescription,
      lessonObjective: lesson.lessonObjective,
      ...lesson.content,
      isCompleted: lesson.isCompleted,
      lessonIndex: lesson.lessonIndex,
    },
    module: {
      title: module.title,
      moduleIndex: module.moduleIndex,
    },
  };
};

const getYouTubeVideosService = async (query) => {
  try {
    return await getYouTubeVideos(query);
  } catch (error) {
    throw error;
  }
};

const checkLessonExistsService = async ({
  courseId,
  userId,
  moduleIndex,
  lessonIndex,
}) => {
  const exists =
    await checkLessonExistsForUser({
      courseId,
      userId,
      moduleIndex,
      lessonIndex,
    });

  return { exists };
};



const saveLessonService = async (
  courseIdOrObj,
  moduleIndex,
  lessonIndex,
  lesson
) => {
  let courseId = courseIdOrObj;
  let actualModuleIndex = moduleIndex;
  let actualLessonIndex = lessonIndex;
  let actualLesson = lesson;

  if (typeof courseIdOrObj === "object" && !courseIdOrObj._bsontype && courseIdOrObj.courseId) {
    courseId = courseIdOrObj.courseId;
    actualModuleIndex = courseIdOrObj.moduleIndex;
    actualLessonIndex = courseIdOrObj.lessonIndex;
    actualLesson = courseIdOrObj.lesson;
  }



  if (!courseId || actualModuleIndex == null || actualLessonIndex == null) {
    throw new Error("Missing required parameters for saving lesson");
  }

  let lessonPayload = {};

  if (actualLesson && actualLesson.data) {
    lessonPayload.content = actualLesson.data;
  } else if (actualLesson && actualLesson.content) {
    lessonPayload = actualLesson;
  } else {
    lessonPayload.content = actualLesson;
  }


  const savedLesson = await saveLesson(
    courseId,
    actualModuleIndex,
    actualLessonIndex,
    lessonPayload
  );

  if (!savedLesson) {
    throw new Error("Failed to save lesson (Course/Module/Lesson not found)");
  }


  return savedLesson;
};

module.exports = {
  saveLessonService,
};




module.exports = {
  saveCourseOutlineToDBService, getRecentCoursesService, getCourseDetailsWithProgressService,
  completeLessonService,
  getLessonContentService,
  checkLessonExistsService,
  saveLessonService,
  getYouTubeVideosService,
};